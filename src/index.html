<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我是你爹！</title>
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/unreset.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.1.1/css/all.min.css">
    <!-- <script src="./js/decode-punycode.js"></script> -->
    <script src="./js/punycode.js"></script>
    <script src="./js/ToolGood.Words.StringSearch.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/dompurify/2.3.8/purify.min.js"></script>
    <script src="https://cdn.staticfile.org/marked/4.0.17/marked.min.js"></script>
</head>

<body>
    <!-- 需要动态设置的类，先在这里添加以让 Tailwind CSS 编译，这种方法不知道行不行，我看有的样式会用变量 -->
    <div class="dh-tailwind-css-classes-init hidden">
        <!-- default 模板在动态调整 Markdown 图片时用到的样式，其中 max-w-3/5 在配置文件中定制 -->
        <div class="dh-template-default-styles max-w-3/5 m-auto object-scale-down"></div>
        <div class="dh-template-test-styles invisible"></div>
    </div>
    <div class="dh-top-screens absolute inset-0 z-50">
        <div class="dh-loading-screen absolute inset-0 bg-yellow-500">
            <div
                class="dh-loading absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 align-middle w-full text-center text-5xl font-bold text-white">
                加载中……</div>
        </div>
        <div class="dh-hint-screen hidden absolute inset-0 bg-yellow-500">
            <div
                class="dh-hint absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 align-middle w-full text-center text-5xl font-bold text-white">
                <div class="dh-loading-hint-title mb-6">
                    格式
                </div>
                <div class="hd-hint-text text-3xl">
                    <a class="dh-hint-link underline" href="https://大儿砸.我是你爹.com">
                        名字.我是你爹.com
                    </a>
                </div>

            </div>
        </div>
        <div class="dh-name-change-screen hidden absolute inset-0 bg-blue-500">
            <div class="dh-name-change absolute p-16 text-9xl text-white">
                <div class="dh-name-change-title mb-16">
                    :(
                </div>
                <div class="dh-name-change-text font-normal text-3xl">
                    你的网页遇到问题，需要换一个名字。
                </div>
            </div>
        </div>
    </div>
    <div class="dh-root absolute inset-0">
        <!-- 以 default 为准 -->
        <!-- break-all：需要模板内所有的长串英文也换行 -->
        <div class="dh-template-default hidden absolute inset-0 break-all bg-blue-50">
            <!-- 最好是通过设置 margin 来调整各项间距，因为 Tailwind CSS 的 space 会影响绝对定位的元素 -->
            <!-- 使用 Tailwind CSS 设计时以小屏优先，大屏加断点 -->
            <div
                class="dh-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-5/6 md:w-3/5 h-5/6 md:h-4/5 flex flex-col flex-nowrap">
                <div class="dh-title ml-6 mb-12 text-left text-5xl font-bold ">
                    <div class="dh-title-name inline"></div>
                    <div class="dh-title-text inline">，我是你爹！</div>
                </div>
                <!-- card 的 overflow-hidden 不能省，省了就顶页面 -->
                <!-- padding 可能需要再调，头像有些挡下方字 -->
                <div
                    class="dh-card flex-grow flex flex-col flex-nowrap px-6 py-6 overflow-hidden rounded-3xl border-2 border-stone-300 shadow-2xl bg-stone-50">
                    <!-- 又包了一层。hidden 和 flex 不能加在同一元素上，因为 Tailwind CSS 的 hidden 实际上是 display: none -->
                    <!-- 现在提供了默认头像，不再使用 hidden -->
                    <div class="dh-avatar-group absolute right-12 -mt-16">
                        <div class="dh-avatars flex flex-nowrap items-center">
                            <div
                                class="dh-avatar w-14 h-14 mr-4 overflow-hidden rounded-md shadow-md border-2 border-stone-300">
                                <!-- 似乎指定了宽高，object-cover 才会工作 -->
                                <img class="dh-avatar-img h-14 w-full object-cover" />
                            </div>
                            <div
                                class="dh-daddy-avatar w-20 h-20 overflow-hidden rounded-md shadow-md border-2 border-stone-300">
                                <img class="dh-daddy-avatar-img h-20 w-full object-cover" />
                            </div>
                        </div>
                    </div>
                    <!-- w-full? -->
                    <div class="dh-markdown unreset mb-6 flex-grow overflow-y-auto overscroll-contain ">
                        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                        <img class=" object-scale-down md:max-w-3/5 " src="https://z3.ax1x.com/2021/05/05/gMI67d.jpg"
                            alt="">
                    </div>
                    <div class="dh-card-tail flex flex-nowrap justify-between">
                        <div class="dh-functions flex flex-nowrap">
                            <div
                                class="dh-function-btn-switch-profile w-12 h-12 mr-4 flex items-center justify-center text-3xl text-gray-500 hover:text-blue-500">
                                <i class="fa-regular fa-address-card"></i>
                            </div>
                            <div
                                class="dh-function-btn-add-profile w-12 h-12 mr-4 flex items-center justify-center text-3xl text-gray-500 hover:text-blue-500">
                                <i class="fa-regular fa-square-plus"></i>
                            </div>
                        </div>
                        <div class="dh-daddy text-right flex items-center justify-center text-xl font-bold ">
                            <!-- 用 flex 是为了文字垂直居中，但会导致里面两个行内 div 在宽度不足时各自换行，需要用 wrapper 修复 -->
                            <div class="dh-daddy-wrapper">
                                <div class="dh-daddy-text inline">爱你的爸爸，</div>
                                <div class="dh-daddy-name inline"></div>
                            </div>
                        </div>
                        <div class="dh-profile-info hidden absolute right-4 bottom-2 text-right text-xs text-gray-500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="dh-music hidden absolute bottom-0">
            </div>
        </div>
        <div class="dh-template-test hidden absolute inset-0 bg-red-50">
            <!-- 最好是通过设置 margin 来调整各项间距，因为 Tailwind CSS 的 space 会影响绝对定位的元素 -->
            <div
                class="dh-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-5/6 md:w-3/5 h-5/6 md:h-4/5 flex flex-col flex-nowrap">
                <div class="dh-title ml-6 mb-12 text-left text-5xl font-bold ">
                    <div class="dh-title-name inline"></div>
                    <div class="dh-title-text inline">，我是你爹！</div>
                </div>
                <div
                    class="dh-card flex-grow flex flex-col flex-nowrap px-6 py-6 rounded-3xl border-2 border-stone-300 shadow-2xl bg-stone-50">
                    <!-- 又包了一层。hidden 和 flex 不能加在同一元素上，因为 Tailwind CSS 的 hidden 实际上是 display: none -->
                    <div class="dh-avatar-group hidden absolute right-12 -mt-14">
                        <div class="dh-avatars flex flex-nowrap items-center">
                            <div
                                class="dh-avatar w-14 h-14 mr-4 overflow-hidden rounded-md shadow-md border-2 border-stone-300">
                                <!-- 似乎指定了宽高，object-cover 才会工作 -->
                                <img class="dh-avatar-img h-14 w-full object-cover" />
                            </div>
                            <div
                                class="dh-daddy-avatar w-20 h-20 overflow-hidden rounded-md shadow-md border-2 border-stone-300">
                                <img class="dh-daddy-avatar-img h-20 w-full object-cover" />
                            </div>
                        </div>
                    </div>
                    <div class="dh-markdown unreset mb-6 flex-grow overflow-y-auto overscroll-contain ">
                    </div>
                    <div class="dh-card-tail flex flex-nowrap justify-between">
                        <div class="dh-functions flex flex-nowrap">
                            <div
                                class="dh-function-btn-switch-profile w-12 h-12 mr-4 flex items-center justify-center text-3xl text-gray-500 hover:text-blue-500">
                                <i class="fa-regular fa-address-card"></i>
                            </div>
                            <div
                                class="dh-function-btn-add-profile w-12 h-12 mr-4 flex items-center justify-center text-3xl text-gray-500 hover:text-blue-500">
                                <i class="fa-regular fa-square-plus"></i>
                            </div>
                        </div>
                        <div class="dh-daddy text-right flex items-center justify-center text-xl font-bold ">
                            <!-- 用 flex 是为了文字垂直居中，但会导致里面两个行内 div 在宽度不足时各自换行，需要用 wrapper 修复 -->
                            <div class="dh-daddy-wrapper">
                                <div class="dh-daddy-text inline">爱你的爸爸，</div>
                                <div class="dh-daddy-name inline"></div>
                            </div>
                        </div>
                        <div class="dh-profile-info hidden absolute right-4 bottom-4 text-right text-xs text-gray-500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="dh-music hidden absolute bottom-0">
            </div>
        </div>
        <div class="dh-pale absolute inset-0 -z-50">如此静谧，仿佛世界离你而去，再没有什么值得牵肠挂肚。这里**什么**都没有。除了你。这是母亲的子宫。<br><br>博学多闻 -
            无色、无味、无特征且坚不可摧、永垂不朽。显然，这是一片**灰域**，而不是子宫。<br><br>见微知著 -
            在久远的过去，开发者泼洒出这片灰域，也许是用于调试，也许是为了一点点乐趣。<br><br>解锁成就：灰域行者
        </div>
    </div>
    <!-- <div class="dh-functions absolute inset-0 z-50">
        <textarea class="dh-ta w-96 h-16" name="" id="" cols="30" rows="10"></textarea>
        <button class="dh-btn w-16 h-12">aaaaaa</button>
        <button class="dh-btn2 w-16 h-12">bbbbbb</button>
    </div> -->
    <script>
        console.log('瞅什么瞅，我是你爹！');
        // let hostTmp = 'xn--vjqt50bik1b.xn--6qq986bm4cjwp.com';
        // let hostTmp = '王刚.xn--6qq986bm4cjwp.com';
        // let hostTmp = 'Hollis.xn--6qq986bm4cjwp.com';
        // let hostTmp = 'xn--6qq986bm4cjwp.com';
        let hostTmp = punycode.ToUnicode('xn--v4qp6qz71a.xn--6qq986bm4cjwp.com'); // 大儿砸.我是你爹.com
        // let hostTmp = '大儿.xn--6qq986bm4cjwp.com';
        // let hostTmp = 'aaaaaa.xn--6qq986bm4cjwp.com';
        // let hostTmp = 'bbbbbb.xn--6qq986bm4cjwp.com';
        let hostSplited = hostTmp.split('.');
        // let hostSplited = punycode.ToUnicode(window.location.host).split['.'];
        if (hostSplited.length === 3) {
            let nameStr = hostSplited[0];
            // let namePunycode = hostSplited[0];
            // let nameStr = namePunycode;
            // if (namePunycode.indexOf('xn--') >= 0) {
            //     let idn = new IdnMapping();
            //     nameStr = idn.toUnicode(namePunycode);
            // }
            let bannedWords = ['毛泽东', '周恩来', '刘少奇', '朱德', '彭德怀', '林彪', '刘伯承', '陈毅', '贺龙', '聂荣臻', '徐向前', '罗荣桓', '叶剑英', '李大钊', '陈独秀', '孙中山', '孙文', '孙逸仙', '邓小平', '陈云', '江泽民', '李鹏', '朱镕基', '李瑞环', '尉健行', '李岚清', '胡锦涛', '罗干', '温家宝', '吴邦国', '曾庆红', '贾庆林', '黄菊', '吴官正', '李长春', '吴仪', '回良玉', '曾培炎', '曹刚川', '唐家璇', '华建敏', '陈至立', '张德江', '俞正声', '王乐泉', '刘云山', '王刚', '王兆国', '刘淇', '贺国强', '郭伯雄', '胡耀邦', '王乐泉', '王兆国', '习近平', '李克强', '张高丽', '刘延东', '彭丽媛', '王岐山', '华国锋', '胡耀邦', '习大大', '吴帮国', '无帮国', '无邦国', '无帮过', '瘟家宝', '假庆林', '甲庆林', '假青林', '离长春', '习远平', '袭近平', '李磕墙', '贺过墙', '和锅枪', '胡主席', '习主席', '毛主席'];
            let bannedWordsTr = ['毛澤東', '周恩來', '劉少奇', '朱德', '彭德懷', '林彪', '劉伯承', '陳毅', '賀龍', '聶榮臻', '徐向前', '羅榮桓', '葉劍英', '李大釗', '陳獨秀', '孫中山', '孫文', '孫逸仙', '鄧小平', '陳雲', '江澤民', '李鵬', '朱镕基', '李瑞環', '尉健行', '李嵐清', '胡錦濤', '羅幹', '溫家寶', '吳邦國', '曾慶紅', '賈慶林', '黃菊', '吳官正', '李長春', '吳儀', '回良玉', '曾培炎', '曹剛川', '唐家璇', '華建敏', '陳至立', '張德江', '俞正聲', '王樂泉', '劉雲山', '王剛', '王兆國', '劉淇', '賀國強', '郭伯雄', '胡耀邦', '王樂泉', '王兆國', '習近平', '李克強', '張高麗', '劉延東', '彭麗媛', '王岐山', '華國鋒', '胡耀邦', '習大大', '吳幫國', '無幫國', '無邦國', '無幫過', '瘟家寶', '假慶林', '甲慶林', '假青林', '離長春', '習遠平', '襲近平', '李磕墻', '賀過墻', '和鍋槍', '胡主席', '習主席', '毛主席'];
            bannedWords = bannedWords.concat(bannedWordsTr);
            let search = new StringSearch();
            search.SetKeywords(bannedWords);
            let invalid = search.ContainsAny(nameStr) || nameStr.length > 10;
            if (!invalid) {

                $('.dh-btn').click(() => {
                    let mk = $('.dh-ta').val();
                    dhPost({
                        entry: '/create',
                        data: JSON.stringify({
                            name: 'bbbbbb',
                            daddy: 'sbsbb',
                            markdown: mk
                        })
                    });
                });
                $('.dh-btn2').click(() => {
                    switchProfile();
                });

                // 先随机生成一套数据，然后发送请求，查无此人或出错都使用随机数据
                // 如果没出错，就选择第一个结果（如果有 hash，选择 hash 对应），设置 hash，提供切换功能，也可切换到随机数据
                // 
                let randomItem = (array) => {
                    return array[Math.floor((Math.random() * array.length))];
                };
                let getTemplate = (name) => {
                    for (let i = 0, length = templates.length; i < length; i++) {
                        if (name === templates[i].name) {
                            return templates[i];
                        }
                    }
                };
                let initTemplateResource = (name) => {
                    templateResources[`template-${name}-resource`] = {};
                };
                let getTemplateResource = (name, resourceName) => {
                    return templateResources[`template-${name}-resource`][resourceName];
                };
                let setTemplateResource = (name, resourceName, resource) => {
                    templateResources[`template-${name}-resource`][resourceName] = resource;
                };
                let removeTemplateResource = (name, resourceName) => {
                    delete templateResources[`template-${name}-resource`].resourceName;
                };
                let switchProfile = (profile) => {
                    // 注意，这里 profile 里的 template 为与后端同一，都只是模板名称，需要获取模板对象使用 getTemplate
                    let luckyTemplate = randomItem(templates);
                    let luckyMarkdown = randomItem(luckyTemplate.data.markdowns);
                    let localProfile = {
                        name: nameStr,
                        daddy: luckyTemplate.data.daddyName,
                        markdown: luckyMarkdown,
                        template: luckyTemplate.name
                    };
                    profile = profile || localProfile;
                    profile.markdown = profile.markdown || localProfile.markdown;
                    // profile.template 为空，或找不到对应模板，都会进入这里
                    if (typeof getTemplate(profile.template) === 'undefined') {
                        profile.template = localProfile.template;
                    }
                    if (JSON.stringify(currentProfile) !== '{}') {
                        getTemplate(currentProfile.template).data.destroy(currentProfile);
                    }
                    getTemplate(profile.template).data.initialize(profile);
                    $(document).attr('title', profile.name + '，我是你爹！');
                    if (profile.id) {
                        window.location.hash = profile.id;
                    }
                    currentProfile = profile;
                };
                let dhRequest = (options) => {
                    const BASE_URL = 'https://daddyshere.hollisdevhub.com/api/sons';
                    options = options || {};
                    let entry = options.entry || '';
                    let method = options.method || 'GET';
                    let contentType = options.contentType || 'application/json';
                    let data = options.data || {};
                    let success = (result, status, xhr) => {
                        if (result.code === 0) {
                            console.log(`${options.method} ${options.entry} 请求成功：`, JSON.parse(JSON.stringify(result))); // 之后任何对 result 的修改都会影响这里，所以打印的时候“复制”一份来打印原样
                            if (typeof options.success === 'function') {
                                options.success(result.result);
                            }
                            return;
                        }
                        else {
                            console.log(`${options.method} ${options.entry} 请求成功，但返回结果标记异常：`, JSON.parse(JSON.stringify(result)));
                            if (typeof options.fail === 'function') {
                                options.fail(status, result.code, result.msg);
                            }
                        }
                    };
                    let fail = (xhr, status, error) => {
                        console.log(`${options.method} ${options.entry} 请求失败：${status}, `, error);
                        if (typeof options.fail === 'function') {
                            options.fail(status);
                        }
                    };
                    let complete = (xhr, status) => {
                        if (typeof options.complete === 'function') {
                            options.complete();
                        }
                    };
                    $.ajax({
                        url: BASE_URL + entry,
                        type: method,
                        contentType: contentType,
                        data: data,
                        timeout: 5000,
                        beforeSend: () => {
                            console.log(`发送 AJAX 请求：${method} ${entry}，数据：`, data);
                        }
                    }).done(success).fail(fail).always(complete);
                };
                let dhGet = (options) => {
                    options = options || {};
                    options.method = 'GET';
                    dhRequest(options);
                };
                let dhPost = (options) => {
                    options = options || {};
                    options.method = 'POST';
                    dhRequest(options);
                };
                let templateResources = {};
                let templates = [
                    {
                        name: 'default',
                        data: {
                            markdowns: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                            daddyName: '某神秘男子',
                            avatar: './imgs/template-default/son.webp', // default 模板提供默认头像，但模板并非必须提供默认头像。实际上，模板不一定显示头像。switchProfile 仅处理必需的数据，其他数据由模板自己处理
                            daddyAvatar: './imgs/template-default/daddy.webp', // 这两个默认头像太二了，需要更新
                            initialize: (profile) => {
                                console.log(`${profile.template} 模板初始化。`);
                                $(`.dh-template-${profile.template} .dh-title-name`).text(profile.name);
                                let daddyCensored = search.Replace(profile.daddy, '❤️');
                                $(`.dh-template-${profile.template} .dh-daddy-name`).text(daddyCensored);
                                profile.avatar = profile.avatar || getTemplate(profile.template).data.avatar;
                                profile.daddyAvatar = profile.daddyAvatar || getTemplate(profile.template).data.daddyAvatar;
                                $(`.dh-template-${profile.template} .dh-avatar-img`).attr('src', profile.avatar);
                                $(`.dh-template-${profile.template} .dh-daddy-avatar-img`).attr('src', profile.daddyAvatar);
                                let markdownCensored = search.Replace(profile.markdown, '❤️');
                                // $(`.dh-template-${profile.template} .dh-markdown`).html(DOMPurify.sanitize(marked.parse(markdownCensored)));
                                // $(`.dh-template-${profile.template} .dh-markdown img`).addClass('max-w-md h-auto object-scale-down');
                                if (profile.cloudMusicId) {
                                    $(`.dh-template-${profile.template} .dh-music`).html(`<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=${profile.cloudMusicId}&auto=1&height=66"></iframe>`);
                                    $(`.dh-template-${profile.template} .dh-music`).removeClass('hidden');
                                }
                                if (profile.expiration) {
                                    profile.reserved ? $(`.dh-template-${profile.template} .dh-profile-info`).text('网友定制，长期保留。') : $(`.dh-template-${profile.template} .dh-profile-info`).text(`网友定制，将于 ${profile.expiration.split('T')[0]} 过期。`);
                                    $(`.dh-template-${profile.template} .dh-profile-info`).removeClass('hidden');
                                }
                                $(`.dh-template-${profile.template}`).removeClass('hidden');
                                console.log(`${profile.template} 模板初始化完成。`);
                            },
                            destroy: (profile) => {
                                console.log(`${profile.template} 模板注销。`);
                                $(`.dh-template-${profile.template} .dh-title-name`).text('');
                                $(`.dh-template-${profile.template} .dh-daddy-name`).text('');
                                $(`.dh-template-${profile.template} .dh-avatar-img`).attr('src', '');
                                $(`.dh-template-${profile.template} .dh-daddy-avatar-img`).attr('src', '');
                                $(`.dh-template-${profile.template} .dh-markdown`).html('');
                                $(`.dh-template-${profile.template} .dh-music`).html('');
                                $(`.dh-template-${profile.template} .dh-music`).addClass('hidden');
                                $(`.dh-template-${profile.template} .dh-profile-info`).text('');
                                $(`.dh-template-${profile.template} .dh-profile-info`).addClass('hidden');
                                $(`.dh-template-${profile.template}`).addClass('hidden');
                                console.log(`${profile.template} 模板注销完成。`);
                            }
                        }
                    },
                    {
                        name: 'test',
                        data: {
                            markdowns: ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';'],
                            daddyName: '乔治·RR·马丁',
                            initialize: (profile) => {
                                console.log(`${profile.template} 模板初始化。`);
                                $(document).attr('title', profile.name + '，我是你爹！');
                                $(`.dh-template-${profile.template} .dh-title-name`).text(profile.name);
                                let daddyCensored = search.Replace(profile.daddy, '❤️');
                                $(`.dh-template-${profile.template} .dh-daddy-name`).text(daddyCensored);

                                if (profile.daddyAvatar) {
                                    $(`.dh-template-${profile.template} .dh-daddy-avatar-img`).attr('src', profile.daddyAvatar);
                                    if (profile.avatar) {
                                        $(`.dh-template-${profile.template} .dh-avatar-img`).attr('src', profile.avatar);
                                    }
                                    $(`.dh-template-${profile.template} .dh-avatar-group`).removeClass('hidden');
                                }
                                let markdownCensored = search.Replace(profile.markdown, '❤️');
                                $(`.dh-template-${profile.template} .dh-markdown`).html(DOMPurify.sanitize(marked.parse(markdownCensored)));
                                if (profile.cloudMusicId) {
                                    $(`.dh-template-${profile.template} .dh-music`).html(`<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=${profile.cloudMusicId}&auto=1&height=66"></iframe>`);
                                    $(`.dh-template-${profile.template} .dh-music`).removeClass('hidden');
                                }
                                if (profile.expiration) {
                                    profile.reserved ? $(`.dh-template-${profile.template} .dh-profile-info`).text('网友定制，长期保留。') : $(`.dh-template-${profile.template} .dh-profile-info`).text(`网友定制，将于 ${profile.expiration.split('T')[0]} 过期。`);
                                }
                                initTemplateResource(`${profile.template}`);
                                let interval = setInterval(() => {
                                    $(`.dh-template-${profile.template} .dh-title`).hasClass('invisible') ? $(`.dh-template-${profile.template} .dh-title`).removeClass('invisible') : $(`.dh-template-${profile.template} .dh-title`).addClass('invisible');
                                }, 1000);
                                setTemplateResource(`${profile.template}`, 'blink', interval);
                                $(`.dh-template-${profile.template}`).removeClass('hidden');
                                console.log(`${profile.template} 模板初始化完成。`);
                            },
                            destroy: (profile) => {
                                console.log(`${profile.template} 模板注销。`);
                                // 也许应该确保先清空 interval 再操作元素，假如没清空 interval 还删除了元素，interval 内留了个引用，会有内存泄漏吧？
                                // 当然也不是说现在一定就没有，我不是程序员，我啥也不懂
                                let interval = getTemplateResource(`${profile.template}`, 'blink');
                                clearInterval(interval);
                                removeTemplateResource(`${profile.template}`, 'blink');
                                $(`.dh-template-${profile.template} .dh-title-name`).text('');
                                $(`.dh-template-${profile.template} .dh-daddy-name`).text('');
                                $(`.dh-template-${profile.template} .dh-avatar-img`).attr('src', '');
                                $(`.dh-template-${profile.template} .dh-daddy-avatar-img`).attr('src', '');
                                $(`.dh-template-${profile.template} .dh-avatar-group`).addClass('hidden');
                                $(`.dh-template-${profile.template} .dh-markdown`).html('');
                                $(`.dh-template-${profile.template} .dh-music`).html('');
                                $(`.dh-template-${profile.template} .dh-music`).addClass('hidden');
                                $(`.dh-template-${profile.template} .dh-profile-info`).text('');
                                $(`.dh-template-${profile.template} .dh-profile-info`).addClass('hidden');
                                $(`.dh-template-${profile.template}`).addClass('hidden');
                                console.log(`${profile.template} 模板注销完成。`);
                            }
                        }
                    }
                ];
                let currentProfile = {};
                let onlineProfiles = [];
                dhGet({
                    entry: `/get-by-name/${nameStr}`,
                    success: (res) => {
                        onlineProfiles = res;
                        let hashId = window.location.hash.replace('#', '');
                        if (hashId !== '') {
                            for (let i = 0, length = res.length; i < length; i++) {
                                if (hashId === res[i].id) {
                                    switchProfile(res[i]);
                                    return;
                                }
                            }
                        }
                        switchProfile(res[0]);
                    },
                    fail: () => { switchProfile(); },
                    complete: () => { $('.dh-top-screens').addClass('hidden'); } // 直接隐藏掉顶层屏幕，不然顶层屏幕绝对定位，点击无法穿透
                });
            } else {
                $('.dh-loading-screen').addClass('hidden');
                $('.dh-name-change-screen').removeClass('hidden');
            }
        } else {
            $('.dh-loading-screen').addClass('hidden');
            $('.dh-hint-screen').removeClass('hidden');
        }
    </script>
</body>

</html>